# 资源抢占

## 概述

当集群资源不足，无法为所有 Pod 分配资源时，调度器会尝试为未被分配资源的 Pod（假设为 Pod A）抢占资源。Pod A 只能抢占队列优先级比自己低的 Pod 的资源。资源抢占成功后，被抢占资源的 Pod 会被删除，Pod A 会被分配资源。

尽管被抢占资源的 Pod 会被直接删除，但是 Pod 所属的父资源（例如 Deployment、[T9k Job](../../../workflow/job/index.md) 等）不会被删除，此时父资源会重新创建 Pod 来申请集群资源，从而可能触发新一轮的抢占行为。以此类推，一次抢占行为可能会触发一系列的抢占行为。因此需要通过设置队列的某些属性，来控制集群对队列的资源抢占行为，例如关闭生产级别队列的抢占开关。

### 抢占开关

通过切换队列的抢占开关，可以控制队列是否可以被抢占资源。关闭抢占开关的队列不可以被抢占资源。

### 优先级

队列配置中的 `spec.priority` 字段表示队列的优先级，高优先级的队列中的 Pod 可以抢占低优先级的队列的资源。

## 示例

假设集群总资源为 `{CPU: 300}`，集群中有四个队列，当前状态如下：

| 队列名称 | 资源配额     | 优先级 | Pod                                            |
| -------- | ------------ | ------ | ---------------------------------------------- |
| A        | `{CPU: 200}` | 1      | A1 `{CPU: 50}`，A2 `{CPU: 50}`，A3 `{CPU: 50}` |
| B        | `{CPU: 100}` | 1      | B1 `{CPU: 50}`                                 |
| C        | `{CPU: 50}`  | 2      | C1 `{CPU: 50}`                                 |
| D        | `{CPU: 200}` | 2      | D1 `{CPU: 50}`                                 |

假如接下来用户进行如下操作：

| 用户操作                                 | 结果 | 原因                                                                               |
| ---------------------------------------- | ---- | ---------------------------------------------------------------------------------- |
| 在队列 B 中创建 <br/> Pod B2 `{CPU: 50}` | 阻塞 | 集群资源已全部分配且队列 B 优先级低，无法抢占其他队列的资源。                      |
| 在队列 C 中创建 <br/> Pod C2 `{CPU: 50}` | 阻塞 | 超过队列 C 的资源配额。                                                            |
| 在队列 D 中创建 <br/> Pod D2 `{CPU: 50}` | 成功 | 发生资源抢占行为，抢占队列 A 的资源：删除 Pod A3（优先级低于 A1、A2），创建 Pod D2。 |
